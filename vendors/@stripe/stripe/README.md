# Stripe (next) Node.js Library

[![Build Status](https://github.com/stripe/stripe-node-next/actions/workflows/main.yml/badge.svg?branch=master)](https://github.com/stripe/stripe-node-next/actions?query=branch%3Amaster)

This is a private build of of the [Stripe Node.js client library](https://github.com/stripe/stripe-node) that contains support for `/v2` APIs.

## Requirements

Node 12 or higher.

## Getting started

1. [Create a personal access token](https://github.com/settings/tokens/new?description=stripe-v2-sdks&scopes=read:packages) on GitHub with the scope `packages:read`.
2. Add a reference to the private feed to `~/.npmrc`. Replace `GITHUB_TOKEN` with the token you just created.
   ```
   //npm.pkg.github.com/:_authToken=GITHUB_TOKEN
   @stripe:registry=https://npm.pkg.github.com
   ```
3. Install `@stripe/stripe` package by running `npm install` or adding an entry to the `package.json`.

   ```bash
   npm install @stripe/stripe --save
   ```

   ```json
   {
     "dependencies": {
       "@stripe/stripe": "0.59.0"
     }
   }
   ```

## Usage

### V1 APIs

```typescript
import Stripe from '@stripe/stripe';
const stripe = new Stripe(apiKey);
await stripe.customers.list();
```

### V2 APIs

```typescript
import Stripe from '@stripe/stripe';

const stripe = new Stripe(v2ApiKey);
await stripe.v2.financialAccounts.createFinancialAccount({
      legal_entity_id: ...,
      business_profile_id: ...
});
```

### V2 APIs - with request signing

```typescript
import Stripe from '@stripe/stripe';
// private key generated by the stripe-next-cli.
// After doing "stripe next login" you can find the private
// key in ~/.config/stripe/config.toml
const privateKeyText = ...;

// Auth token starts with keyinfo*live*...
// You can find this also in ~/.config/stripe/config.toml
const authToken = ...;
const key = crypto.createPrivateKey({
key: Buffer.from(privateKeyText, 'base64'),
format: "der",
type: "pkcs8"});

const stripe = new Stripe(null, {
  authenticator: Stripe.createRequestSigningAuthenticator(
    authToken,
    async signatureBase => {
      return await crypto.sign(null, signatureBase, key);
    }
  )
});

await stripe.v2.financialAccounts.createFinancialAccount({
  legal_entity_id: ...,
  business_profile_id: ...
});
```

Note: V2 credentials cannot authorize V1 requests and vice versa, so if you wish to use both V1 and V2 APIs you will need to initialize two different clients.

## V2 Events

Stripe v2 supports two types of events:

### Notification Events

Notification events are a low-latency event that only includes the ID of the affected objects. API v2 only supports notification events. API v1 endpoints may also generate notification events.

Handle notification events as follows:

```javascript
const event = request.body;

if (event.type == 'outbound_payment.returned') {
  const outboundPayment = await stripe.v2.outboundPayments.retrieve(
    event.related_object.id
  );
}
```

### Change Events

Change events provide a snapshot of the object that has changed and are only available on API v1 endpoints.

Handle change events as follows:

```javascript
const endpoint_secret = 'whsec_...';
const sig_header = request.headers['Stripe-Signature'];

const event = stripe.parseThinEvent(request.body, sig_header, endpoint_secret);

if (event.event_type === 'llama.created') {
  const llama = event.fetchRelatedObject();
}
```

More information on v2 events and their usage can be found on our [event destinations documentation](https://docs.stripe.com/event-destinations).

## Experimental Methods

From time to time, we'll have methods named with an `__experimental` suffix, such as `parseThinEvent__experimental()`. These methods help us test designs before they're ready for general use. These methods **are** safe to use, but they won't follow our standard semantic versioning guarantees.

If you're using an experimental method, make sure to check the pinned issues in the repo for an RFC where you can give feedback.

Once we've gathered enough information, experimental methods will be removed. We'll make sure to provide a migration path to either the non-experimental version of the method or a suitable alternative if it's gone entirely.
